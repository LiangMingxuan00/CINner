```{r setup}
devtools::install_github("dinhngockhanh/CancerSimulator")


library(ggplot2)
library(signals)
library(dendextend)
library(fishplot)

library(CancerSimulator)

devtools::load_all()
devtools::document()
```

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% NEUTRAL FALLOPIAN TUBES - ONE SIMULATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

```{r,fig.height=5,fig.width=10}
# for (i in 1:100){
      MODEL                         <- 'FALLOPIAN-TUBES-NEUTRAL'
      stage_final                   <- 3

      package_simulation            <- SIMULATOR_FULL_PROGRAM_one_simulation(MODEL,stage_final)


      PLOT_total_population_vs_input(package_simulation,MODEL,vec_time_plot=seq(0,84,by=1),unit='year')


      PLOT_clonal_evolution(package_simulation,vec_time_plot=seq(0,84,by=2),unit='year')


      PLOT_copy_number_heatmap(package_simulation,phylo='true',plotcol='total_copy')
      # PLOT_copy_number_heatmap(package_simulation,phylo='true',plotcol='min_copy')


      PLOT_clonal_phylogeny(package_simulation)
# }
```

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SELECTION OF BULK HGSOC - ONE SIMULATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

```{r}
MODEL <- 'HGSOC-BULK'
SIMULATOR_VARIABLES_for_simulation(MODEL)

parameter_set                                         <- list()
parameter_set$vec_selection_rates                     <- rep(0.05,nrow(driver_library))
parameter_set$rate_driver                             <- 1e-16
parameter_set$prob_CN_whole_genome_duplication        <- 1e-6
parameter_set$prob_CN_missegregation                  <- 1e-6
parameter_set$prob_CN_chrom_arm_missegregation        <- 1e-6
parameter_set$prob_CN_focal_amplification             <- 1e-6
parameter_set$prob_CN_focal_deletion                  <- 1e-6
parameter_set$prob_CN_cnloh_interstitial              <- 1e-6
parameter_set$prob_CN_cnloh_terminal                  <- 1e-6
parameter_set$prob_CN_focal_amplification_length      <- 0.1
parameter_set$prob_CN_focal_deletion_length           <- 0.1
parameter_set$prob_CN_cnloh_interstitial_length       <- 0.1
parameter_set$prob_CN_cnloh_terminal_length           <- 0.1

package_simulation            <- ABC_one_simulation(MODEL,parameter_set)



PLOT_total_population_vs_input(package_simulation,MODEL,vec_time_plot=seq(0,84,by=1),unit='year')



PLOT_clonal_evolution(package_simulation,vec_time_plot=seq(0,84,by=1),unit='year')



PLOT_copy_number_heatmap(package_simulation,phylo='true',plotcol='total_copy')
# PLOT_copy_number_heatmap(package_simulation,phylo='true',plotcol='min_copy')



PLOT_clonal_phylogeny(package_simulation)
```

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% MIXTURE EXPERIMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

```{r,fig.height=4,fig.width=10}
print('================================================================================   PART A')
MODEL                         <- 'MIXTURE-A'
stage_final                   <- 3
package_output_A              <- SIMULATOR_FULL_PROGRAM_one_simulation(MODEL,stage_final)

PLOT_copy_number_heatmap(package_output_A,phylo='true',plotcol='total_copy')
# PLOT_copy_number_heatmap(package_output_A,phylo='true',plotcol='min_copy')

PLOT_clonal_phylogeny(package_output_A)

print('================================================================================   PREPARE INITIAL STATE FOR EXPERIMENTS B AND C')
MODEL_NEW                     <- 'MIXTURE-B'
EXTRA_build_model_variables_from_sample(MODEL_NEW,package_output_A)
MODEL_NEW                     <- 'MIXTURE-C'
EXTRA_build_model_variables_from_sample(MODEL_NEW,package_output_A)
print('================================================================================   PART B')
MODEL                         <- 'MIXTURE-B'
stage_final                   <- 3
package_output_B              <- SIMULATOR_FULL_PROGRAM_one_simulation(MODEL,stage_final)

PLOT_copy_number_heatmap(package_output_B,phylo='true',plotcol='total_copy')
# PLOT_copy_number_heatmap(package_output_B,phylo='true',plotcol='min_copy')

PLOT_clonal_phylogeny(package_output_B)

print('================================================================================   PART C')
MODEL                         <- 'MIXTURE-C'
stage_final                   <- 3
package_output_C              <- SIMULATOR_FULL_PROGRAM_one_simulation(MODEL,stage_final)

# PLOT_copy_number_heatmap(package_output_C,phylo='true',plotcol='total_copy')
# PLOT_copy_number_heatmap(package_output_C,phylo='true',plotcol='min_copy')
```

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%% NEUTRAL FALLOPIAN TUBES - MANY SIMULATIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

```{r}
MODEL                         <- 'FALLOPIAN-TUBES-NEUTRAL'
stage_final                   <- 1
N_simulations                 <- 100
SIMULATOR_FULL_PROGRAM_many_simulations(MODEL,stage_final,N_simulations)
```

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SELECTION OF BULK HGSOC - MANY SIMULATIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

```{r}
MODEL <- 'HGSOC-BULK'
SIMULATOR_VARIABLES_for_simulation(MODEL)

parameter_set                                         <- list()
parameter_set$vec_selection_rates                     <- rep(0.05,nrow(driver_library))
parameter_set$rate_driver                             <- 1e-16
parameter_set$prob_CN_whole_genome_duplication        <- 1e-6
parameter_set$prob_CN_missegregation                  <- 1e-6
parameter_set$prob_CN_chrom_arm_missegregation        <- 1e-6
parameter_set$prob_CN_focal_amplification             <- 1e-6
parameter_set$prob_CN_focal_deletion                  <- 1e-6
parameter_set$prob_CN_cnloh_interstitial              <- 1e-6
parameter_set$prob_CN_cnloh_terminal                  <- 1e-6
parameter_set$prob_CN_focal_amplification_length      <- 0.1
parameter_set$prob_CN_focal_deletion_length           <- 0.1
parameter_set$prob_CN_cnloh_interstitial_length       <- 0.1
parameter_set$prob_CN_cnloh_terminal_length           <- 0.1

N_simulations                                         <- 100

ABC_many_simulations(MODEL,parameter_set,N_simulations)
```
